<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–¢–µ–º–Ω—ã–π –ú–∏—Ä ‚Äî –∫–∞—Ä–∫–∞—Å + –ë–æ–π–ë–ª–æ–∫ v1</title>
  <link rel="stylesheet" href="./styles.css?v=6">
  <link rel="stylesheet" href="blocks/combat/combat.css?v=6">
</head>
<body>
  <div id="app">
    <div class="app">
      <div class="carousel" id="carousel">
        <section class="panel">
          <div class="col" id="left">
            <h2>–ü–µ—Ä—Å–æ–Ω–∞–∂</h2>
            <div class="col-content">
              <div class="badge">v1 –ö–∞—Ä–∫–∞—Å ‚Ä¢ —Ç–æ–ª—å–∫–æ UI</div>
              <div class="card"><div class="small">–ò–º—è</div><div style="font-weight:700;font-size:18px;">–ì–µ—Ä–æ–π</div><div class="hr"></div><div class="small">–†–∞—Å–∞ / –ö–ª–∞—Å—Å / –ü–µ—Ä–∫–∏</div><div>–ß–µ–ª–æ–≤–µ–∫ / ‚Äî / ‚Äî</div></div>
              <div class="card"><div class="small">–ü–æ–ª–æ—Å–∫–∏</div><div>HP: 14 ‚Ä¢ –£–¥–∞—á–∞: 3 ‚Ä¢ –£—Å—Ç–∞–ª–æ—Å—Ç—å: 0</div></div>
              <div class="card"><div class="small">–ù–∞–≤—ã–∫–∏ (–ø—Ä–∏–º–µ—Ä)</div><div>–ê—Ç–ª–µ—Ç–∏–∫–∞ 4 ‚Ä¢ –ü–æ–∏—Å–∫ 3 ‚Ä¢ –ú–∞–≥–∏—è 0</div></div>
              <div class="card"><button class="btn btn-dev" id="btnDevBattle" onclick="window.__openCombat()">DEV: –æ—Ç–∫—Ä—ã—Ç—å –±–æ–π</button></div>
            </div>
          </div>
        </section>
        <section class="panel">
          <div class="col col--scroll" id="center">
            <h2>–ì–ª–∞–≤–Ω–∞—è</h2>
            <div class="col-content" id="chat">
              <div class="chat-msg dm">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¢–µ–º–Ω—ã–π –ú–∏—Ä, –æ–¥–∏–Ω–æ–∫–∞—è –¥—É—à–∞.</div>
              <div class="chat-msg dm">–î–µ—Å–∫—Ç–æ–ø: —Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ —Ä—è–¥–æ–º. –ú–æ–±–∞–π–ª: —Å–≤–∞–π–ø–æ–≤–∞—è –∫–∞—Ä—É—Å–µ–ª—å.</div>
              <div class="chat-msg player">–û–∫. –ë–æ–π –∏ d20 –ø–æ—è–≤—è—Ç—Å—è –∫–∞–∫ –æ–≤–µ—Ä–ª–µ–π –ø–æ–≤–µ—Ä—Ö —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–∏.</div>
              <div class="input-wrap">
                <div class="input">
                  <input id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ _–ø—Ä–æ–≤–µ—Ä–∫–∞_–±–æ—è –∏ –Ω–∞–∂–º–∏—Ç–µ Shift+Enter –∏–ª–∏ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª‚Ä¶"/>
                  <button class="btn" id="sendBtn" onclick="window.__sendChat()">üìú –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section class="panel">
          <div class="col" id="right">
            <h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
            <div class="col-content">
              <div class="card"><div class="small">–°–ª–æ—Ç—ã (–ø—Ä–∏–º–µ—Ä)</div><ul style="margin:6px 0 0 18px;"><li>–ë—Ä–æ–Ω—è ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</li><li>–õ–µ–≤–∞—è —Ä—É–∫–∞ ‚Äî –ø—É—Å—Ç–æ</li><li>–ü—Ä–∞–≤–∞—è —Ä—É–∫–∞ ‚Äî –ø—É—Å—Ç–æ</li><li>–ü–æ—è—Å ‚Äî –ø—É—Å—Ç–æ</li></ul></div>
              <div class="card"><div class="small">–¶–≤–µ—Ç–∞</div><div class="palette"><div class="swatch bg"></div><div class="swatch panel"></div><div class="swatch muted"></div><div class="swatch bluegray"></div><div class="swatch accent"></div><div class="swatch danger"></div><div class="swatch white"></div></div></div>
            </div>
          </div>
        </section>
      </div>
      <div class="nav-dots" id="dots" aria-hidden="true"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
  </div>

  <!-- Debug floating opener (inline fallback onclick) -->
  <button id="debugOpenCombat" title="–û—Ç–∫—Ä—ã—Ç—å –±–æ–π" onclick="window.__openCombat()" style="position:fixed;right:14px;bottom:14px;z-index:90;border-radius:999px;padding:10px 14px;border:none;background:#7a57c6;color:#fff;box-shadow:0 8px 18px rgba(0,0,0,.35)">–ë–æ–π</button>

  <!-- Combat Overlay -->
  <div id="combatOverlay" class="combat hidden" aria-hidden="true">
    <div class="combat__wrap combat--vertical">
      <header class="combat__header">
        <div class="combat__title">–ë–æ–π</div>
        <div class="combat__counters">
          <div class="counter" data-kind="atk" title="–û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è">–ê–¢–ö <span id="cntAtk">1</span>/<span>1</span></div>
          <div class="counter" data-kind="move" title="–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏—è">–î–í–ò–ñ <span id="cntMove">1</span>/<span>1</span></div>
          <div class="counter" data-kind="simple" title="–ü—Ä–æ—Å—Ç—ã–µ –¥–µ–π—Å—Ç–≤–∏—è">–ü–†–û–°–¢ <span id="cntSimple">1</span>/<span>1</span></div>
          <div class="badge" id="badgeDefense" hidden>–û–±–æ—Ä–æ–Ω–∞</div>
        </div>
        <div class="combat__tools">
          <button class="icon" id="btnTurnLeft" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –Ω–∞–ª–µ–≤–æ">‚ü≤</button>
          <button class="icon" id="btnTurnRight" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –Ω–∞–ø—Ä–∞–≤–æ">‚ü≥</button>
          <button class="icon" id="btnRollback" title="–û—Ç–∫–∞—Ç–∏—Ç—å —Ö–æ–¥">‚Ü∫</button>
          <button class="icon" id="btnCloseCombat" title="–ó–∞–∫—Ä—ã—Ç—å –±–æ–π">‚úï</button>
        </div>
      </header>

      <div class="combat__board">
        <div class="board-wrap">
          <div class="board" id="board">
            <div class="grid" id="grid"></div>
            <div class="sprites" id="sprites">
              <div class="sprite hero" id="heroSprite"><span>–ì</span></div>
            </div>
          </div>
        </div>

        <div class="actions-bar">
          <div class="actions-row">
            <div class="small">–û—Å–Ω–æ–≤–Ω—ã–µ</div>
            <div class="actions">
              <button class="btn action" id="actMelee">–ë–ª–∏–∂–Ω—è—è</button>
              <button class="btn action" id="actShoot">–í—ã—Å—Ç—Ä–µ–ª</button>
              <button class="btn action" id="actMagic">–ú–∞–≥–∏—è</button>
              <button class="btn action" id="actDefense">–û–±–æ—Ä–æ–Ω–∞</button>
              <button class="btn action" id="actRangerPrecise" title="–†–µ–π–Ω–¥–∂–µ—Ä: –ê–¢–ö+–ü–†–û–°–¢, –∏–≥–Ω–æ—Ä —Ñ–∏–∑. –±—Ä–æ–Ω–∏">–ú–µ—Ç–∫–∏–π –≤—ã—Å—Ç—Ä–µ–ª</button>
            </div>
          </div>
          <div class="actions-row">
            <div class="small">–ü—Ä–æ—Å—Ç—ã–µ</div>
            <div class="actions">
              <button class="btn action" id="actThrow">–ú–µ—Ç–Ω—É—Ç—å</button>
              <button class="btn action" id="actPotion">–ó–µ–ª—å–µ</button>
              <button class="btn action" id="actBandage">–ü–µ—Ä–µ–≤—è–∑–∫–∞</button>
            </div>
          </div>
          <div class="actions-row">
            <div class="small">–î–≤–∏–∂–µ–Ω–∏–µ</div>
            <div class="moves">
              <button class="btn move" data-mv="back">–ù–∞–∑–∞–¥</button>
              <button class="btn move" data-mv="back_diag">–ù–∞–∑–∞–¥ (–¥–∏–∞–≥)</button>
              <button class="btn move" data-mv="fwd">–í–ø–µ—Ä—ë–¥</button>
              <button class="btn move" data-mv="fwd_diag">–í–ø–µ—Ä—ë–¥ (–¥–∏–∞–≥)</button>
              <button class="btn move" data-mv="left">–í–ª–µ–≤–æ</button>
              <button class="btn move" data-mv="right">–í–ø—Ä–∞–≤–æ</button>
            </div>
          </div>
        </div>
      </div>

      <div class="combat__footer">
        <div class="input"><input id="combatInput" placeholder="–û–ø–∏—à–∏—Ç–µ —Ö–æ–¥... (—á–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"/></div>
        <button class="btn btn-end" id="btnEndTurn">–ö–û–ù–ï–¶ –•–û–î–ê</button>
      </div>
    </div>
  </div>

  <!-- Ultra-fallback helpers -->
  <script>
  // minimal render of 7x6 grid so –æ–≤–µ—Ä–ª–µ–π –≤—Å–µ–≥–¥–∞ "–≤–∏–¥–µ–Ω", –¥–∞–∂–µ –µ—Å–ª–∏ combat.js –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è
  (function(){
    function ensureGrid(){
      var grid = document.getElementById('grid');
      if (!grid || grid.childElementCount) return;
      for (var y=-1; y<=4; y++){
        for (var x=-3; x<=3; x++){
          var c=document.createElement('div'); c.className='cell'; c.setAttribute('data-x',x); c.setAttribute('data-y',y);
          grid.appendChild(c);
        }
      }
    }
    window.__openCombat = function(){
      var ov = document.getElementById('combatOverlay');
      if (!ov) return;
      ov.classList.remove('hidden'); ov.setAttribute('aria-hidden','false');
      ensureGrid();
      if (window.CombatOverlay && typeof window.CombatOverlay.open==='function'){
        window.CombatOverlay.open();
      }
    };
    window.__sendChat = function(){
      var input = document.getElementById('chatInput');
      var v = (input && input.value || '').trim();
      if (!v) return;
      if (v.indexOf('_–ø—Ä–æ–≤–µ—Ä–∫–∞_–±–æ—è')>-1) window.__openCombat();
      input.value='';
    };
  })();
  </script>

  <!-- External scripts -->
  <script src="./script.js?v=6"></script>
  <script src="blocks/combat/combat.js?v=6"></script>
  <script type="module" src="/js/combat-overlay.js"></script>
</body>
</html>
