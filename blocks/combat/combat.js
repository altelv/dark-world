(()=>{const qs=(s,r=document)=>r.querySelector(s),qsa=(s,r=document)=>Array.from(r.querySelectorAll(s)),overlay=qs('#combatOverlay'),boardEl=qs('#board'),cntAtk=qs('#cntAtk'),cntMove=qs('#cntMove'),cntSimple=qs('#cntSimple'),badgeDefense=qs('#badgeDefense'),inputDraft=qs('#combatInput'),devBtn=qs('#btnDevBattle'),chatSend=qs('#sendBtn'),chatInput=qs('#chatInput');let facing=0;const character={isRanger:true,rangerPreciseShotAvailable:true,hasThrowOnBelt:true,canCastSimple:false,canCastComplex:false,isAktonist:false};const state={turn:1,spent:{atk:0,move:0,simple:0},caps:{atk:1,move:1,simple:1},hero:{x:0,y:0},enemies:[],obstacles:[],queue:[],draftParts:[],defenseActive:false};const X_MIN=-3,X_MAX=3,Y_MIN=-1,Y_MAX=4;function openDevBattle(){state.enemies=[{id:'e1',name:'Разбойник',x:1,y:2,armor_ph:1,ward_mag:0,shield:false},{id:'e2',name:'Лучник',x:-1,y:3,armor_ph:0,ward_mag:0,shield:true},{id:'e3',name:'Босс',x:0,y:4,armor_ph:2,ward_mag:1,shield:true,boss:true}],state.obstacles=[{x:-2,y:2},{x:2,y:2},{x:1,y:1}],state.hero={x:0,y:0},state.turn=1,resetTurn(),renderBoard(),showOverlay(true)}function showOverlay(v){overlay.classList.toggle('hidden',!v),overlay.setAttribute('aria-hidden',v?'false':'true')}function resetTurn(){state.spent={atk:0,move:0,simple:0},state.queue=[],state.draftParts=[],state.defenseActive=!1,updateCounters(),badgeDefense.hidden=!0,inputDraft.value="",clearHighlights()}function updateCounters(){cntAtk.textContent=String(state.caps.atk-state.spent.atk),cntMove.textContent=String(state.caps.move-state.spent.move),cntSimple.textContent=String(state.caps.simple-state.spent.simple)}function renderBoard(){boardEl.innerHTML="";for(let y=Y_MIN;y<=Y_MAX;y++)for(let x=X_MIN;x<=X_MAX;x++){const cell=document.createElement('div');cell.className='cell',cell.dataset.x=x,cell.dataset.y=y,x===state.hero.x&&y===state.hero.y&&(cell.classList.add('hero'),cell.appendChild(makeLabel('Г'))),state.obstacles.some(o=>o.x===x&&o.y===y)&&(cell.classList.add('obstacle'),cell.appendChild(makeLabel('▧')),cell.addEventListener('mouseenter',()=>highlightCoverFrom(x,y,!0)),cell.addEventListener('mouseleave',()=>highlightCoverFrom(x,y,!1)));const enemy=state.enemies.find(e=>e.x===x&&e.y===y);enemy&&(cell.classList.add('enemy'),cell.appendChild(makeLabel(enemy.boss?'Босс':'Враг'))),cell.addEventListener('click',()=>onCellClick(x,y)),boardEl.appendChild(cell)}}function makeLabel(t){const lb=document.createElement('div');return lb.className='label',lb.textContent=t,lb}function getCell(x,y){return qs(`.cell[data-x="${x}"][data-y="${y}"]`,boardEl)}function clearHighlights(){qsa('.cell',boardEl).forEach(c=>c.classList.remove('target','range','blocked','cover-highlight'))}function canSpend(t,a=1){return state.spent[t]+a<=state.caps[t]}function spend(t,a=1){state.spent[t]+=a,updateCounters()}function addDraft(t){state.draftParts.push(t),inputDraft.value=state.draftParts.join(' ')}function queueMove(kind){if(!canSpend('move'))return toast('Нет очков движения');state.queue.push({kind:'move',data:{kind}}),spend('move',1);const map={back:{dx:0,dy:-1},back_diag:{dx:1,dy:-1},fwd:{dx:0,dy:2},fwd_diag:{dx:1,dy:1},left:{dx:-1,dy:0},right:{dx:1,dy:0}},v=map[kind];addDraft(moveDraftText(kind));const nx=clamp(state.hero.x+v.dx,X_MIN,X_MAX),ny=clamp(state.hero.y+v.dy,Y_MIN,Y_MAX);state.hero.x=nx,state.hero.y=ny,renderBoard()}function moveDraftText(kind){const map={back:'Отошёл назад.',back_diag:'Отошёл назад по диагонали.',fwd:'Шагнул вперёд.',fwd_diag:'Шагнул вперёд по диагонали.',left:'Шагнул влево.',right:'Шагнул вправо.'};return map[kind]||'Сместился.'}function queueDefense(){if(!canSpend('atk'))return toast('Нет очков атаки');state.queue.push({kind:'defense'}),spend('atk',1),state.defenseActive=!0,badgeDefense.hidden=!1,addDraft('Встал в оборону.')}function queueMelee(){if(!canSpend('atk'))return toast('Нет очков атаки');const adj=targetsAdjacent();if(adj.length===0)return toast('Нет цели рядом');highlightTargets(adj),boardEl.onclick=e=>{const t=e.target.closest('.cell.target');if(!t)return;boardEl.onclick=null,clearHighlights();const x=+t.dataset.x,y=+t.dataset.y,enemy=findEnemy(x,y);state.queue.push({kind:'melee',data:{id:enemy.id}}),spend('atk',1),addDraft(`Ударил по ${enemy.name}.`),renderBoard()}}function queueShoot(ignoreArmorPh=!1,ignoreShield=!1,precise=!1){if(!canSpend('atk'))return toast('Нет очков атаки');const tgt=targetsLineOfSight();if(tgt.length===0)return toast('Нет цели по линии');highlightTargets(tgt),boardEl.onclick=e=>{const t=e.target.closest('.cell.target');if(!t)return;boardEl.onclick=null,clearHighlights();const x=+t.dataset.x,y=+t.dataset.y,enemy=findEnemy(x,y),data={id:enemy.id,ignoreArmorPh,ignoreShield,precise};state.queue.push({kind:'shoot',data}),spend('atk',1),precise?(canSpend('simple')?(spend('simple',1),addDraft(`Меткий выстрел по ${enemy.name}.`)):toast('Нет ПРОСТ для Меткого выстрела')):addDraft(`Выстрелил в ${enemy.name}.`),renderBoard()}}function queueMagic(){if(!(character.canCastSimple||character.canCastComplex))return toast('Магия недоступна');if(!canSpend('atk'))return toast('Нет очков атаки');const tgt=targetsMagicRange(4);if(tgt.length===0)return toast('Нет цели для магии (до 4 клеток по линии)');highlightTargets(tgt),boardEl.onclick=e=>{const t=e.target.closest('.cell.target');if(!t)return;boardEl.onclick=null,clearHighlights();const x=+t.dataset.x,y=+t.dataset.y,enemy=findEnemy(x,y);state.queue.push({kind:'magic',data:{id:enemy.id}}),spend('atk',1),addDraft(`Прочитал заклинание на ${enemy.name}.`)}}function queueThrow(){if(!character.hasThrowOnBelt&&!character.isAktonist)return toast('Нет метательного на Поясе');if(!canSpend('simple'))return toast('Нет простых действий');const range=character.isAktonist?3:2,candidates=state.enemies.map(e=>({e,dist:chebDist(state.hero.x,state.hero.y,e.x,e.y)})).filter(o=>o.dist<=range);if(candidates.length===0)return toast('Нет доступных целей для метания');candidates.sort((a,b)=>a.dist-b.dist||a.e.y-b.e.y||a.e.x-b.e.x);const target=candidates[0].e;state.queue.push({kind:'throw',data:{id:target.id,range}}),spend('simple',1),addDraft(`Метнул в ${target.name}.`)}function endTurn(){state.queue.length===0&&addDraft('Ждёт...');const log=state.queue.map(evt=>{switch(evt.kind){case'move':return'Перемещение.';case'defense':return'Оборона активна до следующего хода.';case'melee':return`Атака в ближнем бою по ${ename(evt.data.id)}.`;case'shoot':return evt.data.precise?`Меткий выстрел по ${ename(evt.data.id)} (игнор физ. брони${evt.data.ignoreShield?' и щита':''}).`:`Выстрел по ${ename(evt.data.id)}.`;case'magic':return`Заклинание поражает ${ename(evt.data.id)}.`;case'throw':return`Метательное попадает в ${ename(evt.data.id)}.`;case'potion':return'Выпил зелье.';case'bandage':return'Сделал перевязку.';default:return'Действие.'}}).join(' ');toast(`Ход ${state.turn} завершён. ${log}`),state.turn+=1,resetTurn()}function ename(id){return(state.enemies.find(e=>e.id===id)||{}).name||'цель'}function targetsAdjacent(){const list=[];for(const e of state.enemies)Math.max(Math.abs(e.x-state.hero.x),Math.abs(e.y-state.hero.y))===1&&list.push(e);return list}function targetsLineOfSight(){const list=[];for(const e of state.enemies)(e.x===state.hero.x||e.y===state.hero.y)&&clearLine(state.hero.x,state.hero.y,e.x,e.y)&&list.push(e);return list}function targetsMagicRange(maxDist){const list=[];for(const e of state.enemies)(e.x===state.hero.x||e.y===state.hero.y)&&clearLine(state.hero.x,state.hero.y,e.x,e.y)&&chebDist(state.hero.x,state.hero.y,e.x,e.y)<=maxDist&&list.push(e);return list}function highlightTargets(list){clearHighlights();for(const e of list){const c=getCell(e.x,e.y);c&&c.classList.add('target')}}function onCellClick(x,y){}function clearLine(x1,y1,x2,y2){if(x1===x2){const[a,b]=y1<y2?[y1,y2]:[y2,y1];for(let y=a+1;y<b;y++)if(state.obstacles.some(o=>o.x===x1&&o.y===y))return!1;return!0}if(y1===y2){const[a,b]=x1<x2?[x1,x2]:[x2,x1];for(let x=a+1;x<b;x++)if(state.obstacles.some(o=>o.x===x&&o.y===y1))return!1;return!0}return!1}function highlightCoverFrom(ox,oy,enable){qsa('.cell',boardEl).forEach(c=>c.classList.remove('cover-highlight'));if(!enable)return;const hx=state.hero.x,hy=state.hero.y,dirY=Math.sign(hy-oy)||1;for(let y=oy;dirY>0?y<=Y_MAX:y>=Y_MIN;y+=dirY)for(let x=X_MIN;x<=X_MAX;x++){const dx=Math.abs(x-ox),dy=Math.abs(y-oy);if(dy>=0&&dx<=dy&&(dirY>0&&y>=oy||dirY<0&&y<=oy)){const c=getCell(x,y);c&&c.classList.add('cover-highlight')}}}function chebDist(x1,y1,x2,y2){return Math.max(Math.abs(x1-x2),Math.abs(y1-y2))}function clamp(v,a,b){return Math.max(a,Math.min(b,v))}function toast(msg){const t=document.createElement('div');t.textContent=msg,Object.assign(t.style,{position:'fixed',left:'50%',top:'10px',transform:'translateX(-50%)',background:'rgba(0,0,0,.7)',color:'#fff',padding:'8px 12px',borderRadius:'8px',border:'1px solid var(--border)',zIndex:200}),document.body.appendChild(t),setTimeout(()=>t.remove(),2e3)}qs('#btnCloseCombat').addEventListener('click',()=>showOverlay(!1)),qs('#btnTurnLeft').addEventListener('click',()=>{facing=(facing+270)%360,toast('Повернулся налево')}),qs('#btnTurnRight').addEventListener('click',()=>{facing=(facing+90)%360,toast('Повернулся направо')}),qsa('.move').forEach(b=>b.addEventListener('click',()=>queueMove(b.dataset.mv))),qs('#actDefense').addEventListener('click',queueDefense),qs('#actMelee').addEventListener('click',queueMelee),qs('#actShoot').addEventListener('click',()=>queueShoot(!1,!1,!1)),qs('#actMagic').addEventListener('click',queueMagic),qs('#actThrow').addEventListener('click',queueThrow),qs('#actPotion').addEventListener('click',()=>{if(!canSpend('simple'))return toast('Нет простых');state.queue.push({kind:'potion'}),addDraft('Выпил зелье.'),spend('simple',1)}),qs('#actBandage').addEventListener('click',()=>{if(!canSpend('simple'))return toast('Нет простых');state.queue.push({kind:'bandage'}),addDraft('Перевязался.'),spend('simple',1)});const btnPrecise=qs('#actRangerPrecise');function updateRangerPrecise(){btnPrecise.disabled=!(character.isRanger&&character.rangerPreciseShotAvailable)}btnPrecise.addEventListener('click',()=>{if(!(character.isRanger&&character.rangerPreciseShotAvailable))return toast('Недоступно');queueShoot(!0,!1,!0)}),updateRangerPrecise(),qs('#btnEndTurn').addEventListener('click',endTurn),devBtn?.addEventListener('click',openDevBattle),chatSend?.addEventListener('click',()=>{const v=chatInput.value.trim();if(!v)return;v.includes('_проверка_боя')&&openDevBattle(),chatInput.value=''}),window.CombatOverlay={open:openDevBattle,close:()=>showOverlay(!1),setCharacter:data=>Object.assign(character,data||{}),setCaps:caps=>{state.caps=Object.assign(state.caps,caps||{}),updateCounters()},loadBattle:({hero,enemies,obstacles})=>{hero&&(state.hero={...hero}),enemies&&(state.enemies=enemies.slice()),obstacles&&(state.obstacles=obstacles.slice()),state.turn=1,resetTurn(),renderBoard(),showOverlay(!0)}})();